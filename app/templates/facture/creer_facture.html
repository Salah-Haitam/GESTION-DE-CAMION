{% extends 'base.html' %}
{% load static %}
{% block title %}Création de Facture avec GPS{% endblock %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Création de Facture avec GPS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .gps-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .gps-loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .gps-success {
            background-color: #d1edff;
            border: 1px solid #74c0fc;
            color: #0c5460;
        }
        .gps-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Créer une nouvelle facture</h2>
        
        {% if messages %}
            <div class="alert alert-danger" style="margin-top: 15px;">
                <ul style="margin-bottom: 0;">
                    {% for message in messages %}
                        <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        <!-- Statut GPS -->
        <div id="gps-status" class="gps-status gps-loading">
            <i class="fas fa-spinner fa-spin"></i> Obtention de votre position GPS...
        </div>
        <div id="gps-debug" style="font-size: 0.95em; color: #555; margin-top: 3px;"></div>
        <button type="button" id="refresh-gps" class="btn btn-sm btn-outline-primary" style="margin-top: 5px;">Rafraîchir ma position</button>

        <form method="post" id="facture-form" onsubmit="return validerFormulaire()">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_affectation" class="form-label">Camion</label>
                        {{ form.affectation }}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_poids_marchandise" class="form-label">Poids de la marchandise (tonnes)</label>
                        {{ form.poids_marchandise }}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="id_destination" class="form-label">Ville de destination</label>
                {{ form.destination }}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_prix_par_km" class="form-label">Prix par kilomètre (DH)</label>
                        {{ form.prix_par_km }}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_prix_par_tonne" class="form-label">Prix par tonne (DH)</label>
                        {{ form.prix_par_tonne }}
                    </div>
                </div>
            </div>

            <!-- Champs cachés pour les coordonnées GPS -->
            {{ form.latitude_depart }}
            {{ form.longitude_depart }}

            <div class="mb-3">
                <label for="distance_mode" class="form-label">Mode de calcul de distance</label>
                <select id="distance_mode" class="form-select">
                    <option value="haversine">À vol d'oiseau (Haversine)</option>
                    <option value="route">Par la route (OpenRouteService)</option>
                </select>
                <div id="ors-warning" style="color: #b00; font-size: 0.95em; display: none;">
                    ⚠️ Nécessite une connexion Internet et une clé API OpenRouteService valide dans le code.
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5>Aperçu des calculs</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Distance calculée:</strong>
                            <span id="distance-preview">-- km</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Frais de transport:</strong>
                            <span id="transport-preview">-- DH</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Total estimé:</strong>
                            <span id="total-preview">-- DH</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                    Créer la facture
                </button>
                <a href="{% url 'facture_list' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let userPosition = null;
        let coordsDest = null;
        // Fonction pour obtenir la position GPS à chaque soumission
        function updateGPSFields() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userPosition = position;
                        document.getElementById('id_latitude_depart').value = position.coords.latitude;
                        document.getElementById('id_longitude_depart').value = position.coords.longitude;
                        document.getElementById('gps-status').className = 'gps-status gps-success';
                        document.getElementById('gps-status').innerHTML = '<i class="fas fa-check-circle"></i> Position GPS récupérée';
                        resolve();
                    }, function(error) {
                        document.getElementById('gps-status').className = 'gps-status gps-error';
                        document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Impossible de récupérer la position GPS';
                        reject(error);
                    }, {enableHighAccuracy: true, timeout: 10000, maximumAge: 0});
                } else {
                    document.getElementById('gps-status').className = 'gps-status gps-error';
                    document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS non supporté par ce navigateur';
                    reject('no-gps');
                }
            });
        }

        // Empêche la soumission tant que la position n'est pas à jour
        document.getElementById('facture-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('gps-status').className = 'gps-status gps-loading';
            document.getElementById('gps-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtention de votre position GPS...';
            try {
                await updateGPSFields();
                document.getElementById('submit-btn').disabled = false;
                this.submit();
            } catch (err) {
                alert("Impossible de récupérer la position GPS. Veuillez autoriser l'accès à la localisation et réessayer.");
                document.getElementById('submit-btn').disabled = false;
            }
        });

        // Récupère la position GPS au chargement initial pour affichage
        window.addEventListener('DOMContentLoaded', function() {
    updateGPSFields();
    document.getElementById('refresh-gps').addEventListener('click', function() {
        updateGPSFields();
    });
});

// Ajoute debug coordonnées et vérification de la ville
async function updateGPSFields() {
    return new Promise((resolve, reject) => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async function(position) {
                userPosition = position;
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('id_latitude_depart').value = lat;
                document.getElementById('id_longitude_depart').value = lng;
                document.getElementById('gps-status').className = 'gps-status gps-success';
                document.getElementById('gps-status').innerHTML = '<i class="fas fa-check-circle"></i> Position GPS récupérée.';
                // Affiche coordonnées brutes
                document.getElementById('gps-debug').innerText = `Coordonnées détectées : lat = ${lat}, lng = ${lng}`;
                // Reverse geocoding
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                    const data = await response.json();
                    let city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.county || 'Inconnue';
                    let cityLat = parseFloat(data.lat);
                    let cityLon = parseFloat(data.lon);
                    // Calcul distance entre point GPS et ville retournée
                    const R = 6371;
                    const dLat = (cityLat - lat) * Math.PI / 180;
                    const dLon = (cityLon - lng) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat * Math.PI / 180) * Math.cos(cityLat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const distance = R * c;
                    let alertMsg = '';
                    if (distance > 5) {
                        alertMsg = ` ⚠️ Ville détectée : ${city} (écart de ${distance.toFixed(1)} km avec votre position GPS)`;
                    } else {
                        alertMsg = ` Ville détectée : ${city}`;
                    }
                    document.getElementById('gps-debug').innerText += alertMsg;
                } catch (e) {
                    document.getElementById('gps-debug').innerText += ' (reverse geocoding échoué)';
                }
                resolve();
            }, function(error) {
                document.getElementById('gps-status').className = 'gps-status gps-error';
                document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Impossible de récupérer la position GPS';
                document.getElementById('gps-debug').innerText = '';
                reject(error);
            }, {enableHighAccuracy: true, timeout: 10000, maximumAge: 0});
        } else {
            document.getElementById('gps-status').className = 'gps-status gps-error';
            document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS non supporté par ce navigateur';
            document.getElementById('gps-debug').innerText = '';
            reject('no-gps');
        }
    });
}


        // Dictionnaire des villes marocaines et leurs coordonnées GPS (extrait, tu peux en ajouter d'autres)
        const villesCoords = {
            "------": [0, 0],
            "Agadir": [30.4278, -9.5981],
            "Ain Harrouda": [33.6422, -7.4839],
            "Ain Sebaa": [33.6167, -7.5000],
            "Ait Melloul": [30.3342, -9.4971],
            "Akhfenir": [28.0931, -12.0503],
            "Al Hoceima": [35.2442, -3.9315],
            "Aourir": [30.5167, -9.6667],
            "Arfoud": [31.4372, -4.2328],
            "Asilah": [35.4652, -6.0340],
            "Azemmour": [33.2861, -8.3422],
            "Azrou": [33.4361, -5.2211],
            "Ben Guerir": [32.2333, -7.9500],
            "Berkane": [34.9204, -2.3166],
            "Berrechid": [33.2655, -7.5877],
            "Biougra": [30.2500, -9.3667],
            "Bni Hadifa": [35.0053, -4.7444],
            "Bouarfa": [32.5250, -1.9789],
            "Boulemane": [33.3667, -4.7333],
            "Bouskoura": [33.4489, -7.6616],
            "Bouznika": [33.7892, -7.1543],
            "Béni Mellal": [32.3394, -6.3608],
            "Casablanca": [33.5731, -7.5898],
            "Chefchaouen": [35.1688, -5.2636],
            "Dcheira El Jihadia": [30.3737, -9.5466],
            "Demnate": [31.7326, -7.0085],
            "El Aioun Sidi Mellouk": [34.5833, -2.5000],
            "El Jadida": [33.2471, -8.4960],
            "El Kelaa des Sraghna": [32.0500, -7.4167],
            "Errachidia": [31.9314, -4.4248],
            "Essaouira": [31.5085, -9.7595],
            "Fnideq": [35.8493, -5.3589],
            "Fquih Ben Salah": [32.5000, -6.7167],
            "Fès": [34.0331, -5.0003],
            "Guelmim": [28.9870, -10.0574],
            "Guercif": [34.2333, -3.3667],
            "Had Soualem": [33.4777, -7.7353],
            "Ifrane": [33.5331, -5.1059],
            "Imzouren": [35.1500, -3.8500],
            "Jerada": [34.3100, -2.1590],
            "Kalaat Mgouna": [31.2452, -6.1322],
            "Kenitra": [34.2610, -6.5802],
            "Khemisset": [33.8247, -6.0663],
            "Khouribga": [32.8822, -6.9063],
            "Ksar El Kebir": [35.0000, -5.9000],
            "Larache": [35.1932, -6.1557],
            "Marrakech": [31.6295, -7.9811],
            "Martil": [35.6167, -5.2667],
            "Mechra Bel Ksiri": [34.5742, -5.9397],
            "Meknès": [33.8935, -5.5473],
            "Midelt": [32.6854, -4.7451],
            "Missour": [33.0478, -3.9891],
            "Mohammedia": [33.6861, -7.3829],
            "Nador": [35.1681, -2.9335],
            "Ouarzazate": [30.9206, -6.8934],
            "Ouazzane": [34.7981, -5.5786],
            "Oued Zem": [32.8667, -6.5667],
            "Oujda": [34.6833, -1.9095],
            "Oulad Teima": [30.3972, -9.2097],
            "Rabat": [34.020882, -6.84165],
            "Safi": [32.2994, -9.2372],
            "Salé": [34.0536, -6.7985],
            "Sefrou": [33.8305, -4.8353],
            "Settat": [33.0010, -7.6166],
            "Sidi Bennour": [32.6522, -8.4476],
            "Sidi Ifni": [29.3833, -10.1667],
            "Sidi Kacem": [34.2263, -5.7148],
            "Sidi Slimane": [34.2643, -5.9938],
            "Sidi Taibi": [34.2908, -6.6906],
            "Sidi Yahya El Gharb": [34.3053, -6.3044],
            "Skhirat": [33.8500, -7.0333],
            "Souk El Arbaa": [34.6867, -5.9397],
            "Talsint": [32.5333, -2.4833],
            "Tan-Tan": [28.4380, -11.1030],
            "Tanant": [32.0000, -6.7000],
            "Tanger": [35.7595, -5.83395],
            "Taourirt": [34.4136, -2.8857],
            "Taroudant": [30.4720, -8.8769],
            "Taza": [34.2164, -4.0088],
            "Temara": [33.9256, -6.9063],
            "Tichla": [23.5000, -14.5333],
            "Tiflet": [33.8947, -6.3069],
            "Tinghir": [31.5147, -5.5328],
            "Tiznit": [29.6974, -9.7323],
            "Tétouan": [35.5785, -5.3684],
            "Youssoufia": [32.2500, -8.5300],
            "Zagora": [30.3325, -5.8380],
            "Zemmoura": [34.0211, -6.3225],
        };

        // Fonction de calcul de distance Haversine
        function haversineDistance(lat1, lon1, lat2, lon2) {
            function toRad(x) { return x * Math.PI / 180; }
            const R = 6371; // Rayon de la Terre en km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Test manuel de la fonction Haversine avec Casablanca-Rabat
        // Casablanca: 33.5731, -7.5898 | Rabat: 34.0209, -6.8416
        const testDist = haversineDistance(33.5731, -7.5898, 34.0209, -6.8416);
        console.log('[TEST Haversine] Casablanca-Rabat :', testDist.toFixed(2), 'km (attendu ~86 km)');

        // Fonction pour récupérer la distance routière via OpenRouteService
        async function getRouteDistance(lat1, lon1, lat2, lon2) {
            const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjdlMDQyY2QwZWY1NTQ5M2M5ZGExODY3MDJhM2JjMGY1IiwiaCI6Im11cm11cjY0In0='; // clé OpenRouteService
            if (!apiKey || apiKey === 'YOUR_API_KEY') {
                document.getElementById('ors-warning').textContent = '⚠️ Clé API OpenRouteService manquante ou invalide.';
                document.getElementById('ors-warning').style.display = 'block';
                return null;
            }
            const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${lon1},${lat1}&end=${lon2},${lat2}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.features && data.features.length > 0) {
                    // La distance est en mètres, on la convertit en kilomètres
                    document.getElementById('ors-warning').style.display = 'none';
                    const distanceKm = data.features[0].properties.summary.distance / 1000;
                    return distanceKm;
                } else {
                    document.getElementById('ors-warning').textContent = '⚠️ Erreur lors de la récupération de la distance routière (vérifiez la clé API et la connexion Internet).';
                    document.getElementById('ors-warning').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('ors-warning').textContent = '⚠️ Erreur réseau ou quota OpenRouteService dépassé.';
                document.getElementById('ors-warning').style.display = 'block';
                console.error('Erreur OpenRouteService:', error);
            }
            return null;
        }

        // Met à jour uniquement les frais et le total sans recalculer la distance
        function updateFraisEtTotal() {
            if (!gpsReady) return;
            const distanceText = document.getElementById('distance-preview').textContent;
            // Extraire le nombre de la chaîne (ex : "85.2 km" -> 85.2)
            const distance = parseFloat(distanceText.replace(',', '.'));
            const submitBtn = document.querySelector('button[type="submit"]');
            if (isNaN(distance) || distance <= 0) {
                document.getElementById('transport-preview').textContent = '-- DH';
                document.getElementById('total-preview').textContent = '-- DH';
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            const prixKm = parseFloat(document.getElementById('id_prix_par_km').value) || 0;
            const prixTonne = parseFloat(document.getElementById('id_prix_par_tonne').value) || 0;
            const poids = parseFloat(document.getElementById('id_poids_marchandise').value) || 0;
            const frais = distance * prixKm;
            const total = frais + (poids * prixTonne);
            document.getElementById('transport-preview').textContent = frais.toFixed(2) + ' DH';
            document.getElementById('total-preview').textContent = total.toFixed(2) + ' DH';
            if (submitBtn) submitBtn.disabled = false;
        }

        // Met à jour l'aperçu des calculs dès qu'un champ pertinent change (distance)
        async function updateApercuCalculs() {
            if (!gpsReady) return;
            // Toujours masquer l'avertissement au début du calcul
            document.getElementById('ors-warning').style.display = 'none';
            document.getElementById('ors-warning').textContent = '⚠️ Nécessite une connexion Internet et une clé API OpenRouteService valide dans le code.';

            const villeDest = document.getElementById('id_destination').value.trim();
            const lat1 = parseFloat(document.getElementById('id_latitude_depart').value);
            const lng1 = parseFloat(document.getElementById('id_longitude_depart').value);
            const mode = document.getElementById('distance_mode').value;
            const submitBtn = document.querySelector('button[type="submit"]');

            // Vérification stricte de la position GPS de départ
            const isLatValid = typeof lat1 === 'number' && !isNaN(lat1) && Math.abs(lat1) > 1;
            const isLngValid = typeof lng1 === 'number' && !isNaN(lng1) && Math.abs(lng1) > 1;
            if (!isLatValid || !isLngValid) {
                document.getElementById('distance-preview').textContent = '-- km';
                document.getElementById('transport-preview').textContent = '-- DH';
                document.getElementById('total-preview').textContent = '-- DH';
                if (submitBtn) submitBtn.disabled = true;
                // Message explicite pour l'utilisateur
                const gpsStatus = document.getElementById('gps-status');
                if (gpsStatus) {
                    gpsStatus.className = 'gps-status gps-error';
                    gpsStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Veuillez attendre la récupération de la position GPS avant de remplir les autres champs.';
                }
                return;
            }

            // Récupérer les coordonnées de la destination
            let coords = null;
            if (villesCoords[villeDest]) {
                coords = {lat: villesCoords[villeDest][0], lng: villesCoords[villeDest][1]};
            } else if (villeDest) {
                coords = await geocoderAdresse(villeDest);
            }
            coordsDest = coords;

            let distance = 0;
            if (coordsDest && isLatValid && isLngValid && (coordsDest.lat !== 0 || coordsDest.lng !== 0)) {
                if (mode === 'route') {
                    distance = await getRouteDistance(lat1, lng1, coordsDest.lat, coordsDest.lng);
                } else {
                    distance = haversineDistance(lat1, lng1, coordsDest.lat, coordsDest.lng);
                }
            }
            console.log('[updateApercuCalculs] Départ:', lat1, lng1, '| Arrivée:', coordsDest);
            console.log('[updateApercuCalculs] Distance calculée:', distance, 'km');
            document.getElementById('distance-preview').textContent = isNaN(distance) ? '-- km' : distance.toFixed(1) + ' km';
            updateFraisEtTotal();
        }

        // N'appelle updateApercuCalculs QUE sur les champs qui changent la distance
        document.getElementById('id_destination').addEventListener('change', updateApercuCalculs);
        document.getElementById('id_latitude_depart').addEventListener('change', updateApercuCalculs);
        document.getElementById('id_longitude_depart').addEventListener('change', updateApercuCalculs);
        document.getElementById('distance_mode').addEventListener('change', updateApercuCalculs);

        // Pour prix/poids, on met à jour uniquement les frais/total
        ['id_prix_par_km', 'id_prix_par_tonne', 'id_poids_marchandise'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateFraisEtTotal);
        });

    let gpsReady = false;

    function setFormEnabled(enabled) {
        const fields = [
            'id_destination', 'id_prix_par_km', 'id_prix_par_tonne', 'id_poids_marchandise', 'distance_mode'
        ];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enabled;
        });
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = !enabled;
    }

    // Désactiver tout au chargement
    window.addEventListener('DOMContentLoaded', () => {
        setFormEnabled(false);
    });

    // Mettre à jour l'aperçu dès que la position GPS est récupérée
    function afterGPSUpdate() {
        gpsReady = true;
        setFormEnabled(true);
        updateApercuCalculs();
    }

        // Modifie updateGPSFields pour appeler afterGPSUpdate
        function updateGPSFields() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userPosition = position;
                        document.getElementById('id_latitude_depart').value = position.coords.latitude;
                        document.getElementById('id_longitude_depart').value = position.coords.longitude;
                        document.getElementById('gps-status').className = 'gps-status gps-success';
                        // Reverse geocoding pour obtenir la ville depuis les coordonnées
                        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`)
                          .then(response => response.json())
                          .then(data => {
                              let ville = (data.address && (data.address.city || data.address.town || data.address.village || data.address.municipality || data.address.state)) || 'Inconnue';
                              document.getElementById('gps-status').innerHTML = `<i class='fas fa-check-circle'></i> Position GPS récupérée <br><span style='font-size:0.95em;'>Départ : <b>${ville}</b> (lat : ${position.coords.latitude.toFixed(5)}, lng : ${position.coords.longitude.toFixed(5)})</span>`;
                          })
                          .catch(() => {
                              document.getElementById('gps-status').innerHTML = `<i class='fas fa-check-circle'></i> Position GPS récupérée <br><span style='font-size:0.95em;'>Départ : <b>Inconnue</b> (lat : ${position.coords.latitude.toFixed(5)}, lng : ${position.coords.longitude.toFixed(5)})</span>`;
                          });
                        afterGPSUpdate();
                        resolve();
                    }, function(error) {
                        document.getElementById('gps-status').className = 'gps-status gps-error';
                        document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Impossible de récupérer la position GPS';
                        reject(error);
                    }, {enableHighAccuracy: true, timeout: 10000, maximumAge: 0});
                } else {
                    document.getElementById('gps-status').className = 'gps-status gps-error';
                    document.getElementById('gps-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS non supporté par ce navigateur';
                    reject('no-gps');
                }
            });
        }

        // Fonction pour valider le formulaire avant soumission
        function validerFormulaire() {
            const lat = document.getElementById('id_latitude_depart').value;
            const lng = document.getElementById('id_longitude_depart').value;
            
            if (!lat || !lng) {
                alert("Veuillez autoriser l'accès à votre position GPS pour continuer.");
                return false;
            }
            return true;
        }

        // Fonction pour obtenir la position GPS
        function obtenirPositionGPS() {
            const statusDiv = document.getElementById('gps-status');
            const submitBtn = document.getElementById('submit-btn');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Mise à jour des champs cachés
                        document.getElementById('id_latitude_depart').value = userPosition.lat;
                        document.getElementById('id_longitude_depart').value = userPosition.lng;

                        // Mise à jour du statut
                        statusDiv.className = 'gps-status gps-success';
                        statusDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            Position GPS obtenue: ${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}
                        `;

                        // Calculer la distance si la destination est déjà saisie
                        calculerDistance();
                        
                        // Activer le bouton de soumission
                        submitBtn.disabled = false;
                    },
                    function(error) {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Accès à la géolocalisation refusé";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Position non disponible";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Timeout de géolocalisation";
                                break;
                            default:
                                errorMessage = "Erreur de géolocalisation";
                                break;
                        }

                        statusDiv.className = 'gps-status gps-error';
                        statusDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i> 
                            ${errorMessage}. Veuillez autoriser l'accès à votre position.
                        `;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                statusDiv.className = 'gps-status gps-error';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    La géolocalisation n'est pas supportée par ce navigateur.
                `;
            }
        }

        // Fonction pour géocoder une adresse
        async function geocoderAdresse(adresse) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(adresse)}&format=json&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'FactureApp/1.0'
                        }
                    }
                );
                
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Erreur géocodage:', error);
            }
            return null;
        }

        // Fonction pour calculer la distance
        function calculerDistance() {
            if (!userPosition || !coordsDest) return;

            // Affichage des coordonnées utilisées
            console.log('[calculerDistance] Départ:', userPosition.lat, userPosition.lng, '| Arrivée:', coordsDest.lat, coordsDest.lng);

            // Calcul de la distance en kilomètres (formule haversine)
            const distance = haversineDistance(userPosition.lat, userPosition.lng, coordsDest.lat, coordsDest.lng);

            // Affichage de la distance calculée
            console.log('[calculerDistance] Distance calculée:', distance, 'km');

            document.getElementById('distance-preview').textContent = distance.toFixed(2) + ' km';
            calculerFrais(distance);
        }

        // Fonction pour calculer les frais
        function calculerFrais(distance) {
            const prixParKm = parseFloat(document.getElementById('id_prix_par_km').value) || 0;
            const prixParTonne = parseFloat(document.getElementById('id_prix_par_tonne').value) || 0;
            const poids = parseFloat(document.getElementById('id_poids_marchandise').value) || 0;

            const fraisTransport = distance * prixParKm;
            const fraisMarchandise = poids * prixParTonne;
            const total = fraisTransport + fraisMarchandise;

            document.getElementById('transport-preview').textContent = fraisTransport.toFixed(2) + ' DH';
            document.getElementById('total-preview').textContent = total.toFixed(2) + ' DH';
        }

        // Événements
        document.getElementById('id_destination').addEventListener('blur', async function() {
            const adresse = this.value.trim();
            if (adresse) {
                coordsDest = await geocoderAdresse(adresse);
                calculerDistance();
            }
        });

        // Recalculer lors de la modification des prix
        ['id_prix_par_km', 'id_prix_par_tonne', 'id_poids_marchandise'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                if (userPosition && coordsDest) {
                    const distance = parseFloat(document.getElementById('distance-preview').textContent);
                    if (!isNaN(distance)) {
                        calculerFrais(distance);
                    }
                }
            });
        });

        // Initialiser la géolocalisation à CHAQUE affichage de la page
        document.addEventListener('DOMContentLoaded', function() {
            userPosition = null; // Réinitialise la position à chaque chargement
            obtenirPositionGPS();
        });
        // Bouton "Rafraîchir ma position" : toujours redemander l'autorisation
        document.getElementById('refresh-gps').addEventListener('click', function() {
            userPosition = null;
            obtenirPositionGPS();
        });
    </script>
{% endblock %}