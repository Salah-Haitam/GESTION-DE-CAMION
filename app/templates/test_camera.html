<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Caméra Arrière</title>
</head>
<body>
    <h1>Test Caméra Mobile - Arrière</h1>
    <video id="video" width="320" height="240" autoplay playsinline></video>
    <br><br>
    <button id="switchCamera">Basculer Caméra</button>
    <button id="takePhoto">Prendre Photo</button>
    <br><br>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="photo" style="max-width: 320px; display: none;">
    <div id="status">Chargement...</div>
    
    <script>
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        const switchBtn = document.getElementById('switchCamera');
        const takePhotoBtn = document.getElementById('takePhoto');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        
        let currentStream = null;
        let facingMode = 'environment'; // 'environment' = caméra arrière, 'user' = caméra frontale
        
        // Afficher les informations du navigateur
        status.innerHTML = `
            <p>Navigateur: ${navigator.userAgent}</p>
            <p>Plateforme: ${navigator.platform}</p>
            <p>MediaDevices supporté: ${!!navigator.mediaDevices}</p>
        `;
        
        async function startCamera() {
            try {
                // Arrêter le flux précédent s'il existe
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Configuration pour la caméra arrière
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                
                // Obtenir les informations sur la caméra utilisée
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();
                
                status.innerHTML += `
                    <p style="color:green">Caméra ${facingMode === 'environment' ? 'arrière' : 'frontale'} activée!</p>
                    <p>Résolution: ${settings.width}x${settings.height}</p>
                    <p>Label: ${videoTrack.label}</p>
                `;
                
            } catch (err) {
                status.innerHTML += `<p style="color:red">Erreur: ${err.name} - ${err.message}</p>`;
                
                // Si la caméra arrière n'est pas disponible, essayer la frontale
                if (facingMode === 'environment') {
                    status.innerHTML += '<p style="color:orange">Tentative avec la caméra frontale...</p>';
                    facingMode = 'user';
                    startCamera();
                }
            }
        }
        
        // Fonction pour basculer entre les caméras
        switchBtn.addEventListener('click', () => {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            startCamera();
        });
        
        // Fonction pour prendre une photo
        takePhotoBtn.addEventListener('click', () => {
            if (currentStream) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const dataURL = canvas.toDataURL('image/jpeg');
                photo.src = dataURL;
                photo.style.display = 'block';
                
                status.innerHTML += '<p style="color:blue">Photo prise!</p>';
            }
        });
        
        // Démarrer la caméra au chargement de la page
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            startCamera();
        } else {
            status.innerHTML += '<p style="color:red">Votre navigateur ne supporte pas l\'accès à la caméra</p>';
        }
        
        // Nettoyer les ressources quand la page se ferme
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>